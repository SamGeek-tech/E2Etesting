# Pipeline that triggers on Pull Request creation
# Runs code quality checks against Azure DevOps (no test execution)

trigger: none  # Don't trigger on push, only on PR

pr:
  branches:
    include:
    - '*'  # Trigger on PRs to any branch
  paths:
    exclude:
    - README.md
    - '*.md'
    - 'docs/**'

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages

stages:
- stage: Build
  displayName: 'ðŸ”¨ Build & Validate'
  jobs:
  - job: BuildJob
    displayName: 'Build Solution'
    steps:
    - pwsh: |
        Write-Host "=========================================="
        Write-Host "ðŸš€ PULL REQUEST CODE VALIDATION"
        Write-Host "=========================================="
        Write-Host "Build ID: $(Build.BuildId)"
        Write-Host "Build Number: $(Build.BuildNumber)"
        Write-Host "Source Branch: $(Build.SourceBranch)"
        Write-Host "Source Branch Name: $(Build.SourceBranchName)"
        
        # Check for PR variables (available only in PR builds)
        $prNumber = "$(System.PullRequest.PullRequestNumber)"
        $prSourceBranch = "$(System.PullRequest.SourceBranch)"
        
        # Get target branch from environment variable (System.PullRequest.TargetBranch is not a valid predefined variable)
        $prTargetBranch = $env:SYSTEM_PULLREQUEST_TARGETBRANCH
        if (-not $prTargetBranch) {
          $prTargetBranch = ""
        }
        
        if ($prNumber -and $prNumber -ne "") {
          Write-Host "PR Number: $prNumber"
          if ($prSourceBranch -and $prSourceBranch -ne "") {
            Write-Host "PR Source Branch: $prSourceBranch"
          }
          if ($prTargetBranch -and $prTargetBranch -ne "") {
            Write-Host "PR Target Branch: $prTargetBranch"
          }
        } else {
          Write-Host "PR Number: Not available (may be triggered manually or on push)"
        }
        
        Write-Host "Build Reason: $(Build.Reason)"
        Write-Host "Configuration: $(buildConfiguration)"
        Write-Host "Azure DevOps Organization: $(System.TeamFoundationCollectionUri)"
        Write-Host "Azure DevOps Project: $(System.TeamProject)"
        Write-Host "Repository: $(Build.Repository.Name)"
        Write-Host "=========================================="
      displayName: 'ðŸ“‹ PR Information'

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET 8 SDK'

    # âš¡ CACHE: NuGet packages
    - task: Cache@2
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/*.csproj'
        restoreKeys: |
          nuget | "$(Agent.OS)"
        path: $(NUGET_PACKAGES)
      displayName: 'âš¡ Cache NuGet packages'

    - pwsh: |
        Write-Host "ðŸ“¦ Restoring dependencies..."
        dotnet restore --verbosity minimal
      displayName: 'ðŸ“¦ Restore Dependencies'

    - pwsh: |
        Write-Host "ðŸ”¨ Building solution..."
        dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'ðŸ”¨ Build Solution'

    - pwsh: |
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âŒ Build failed!"
          exit 1
        }
        Write-Host "âœ… Build succeeded"
      displayName: 'âœ… Verify Build'

- stage: CodeQuality
  displayName: 'ðŸ” Code Quality Checks (Azure DevOps)'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: CodeQuality_Job
    displayName: 'Code Quality Validation'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET SDK'

    - pwsh: |
        Write-Host "=========================================="
        Write-Host "ðŸ” CODE QUALITY CHECKS - AZURE DEVOPS"
        Write-Host "=========================================="
        Write-Host "Running code validation against Azure DevOps..."
        Write-Host "Organization: $(System.TeamFoundationCollectionUri)"
        Write-Host "Project: $(System.TeamProject)"
        Write-Host "Repository: $(Build.Repository.Name)"
        Write-Host "=========================================="
      displayName: 'ðŸ“‹ Code Quality Info'

    # Check for build warnings
    - pwsh: |
        Write-Host "ðŸ”¨ Analyzing build output for warnings and errors..."
        $buildOutput = dotnet build --configuration $(buildConfiguration) --verbosity normal 2>&1
        $warnings = $buildOutput | Select-String -Pattern "warning"
        $errors = $buildOutput | Select-String -Pattern "error"
        
        if ($errors) {
          Write-Host "âŒ Build errors found:"
          $errors | ForEach-Object { Write-Host "  $_" }
          Write-Host "Please fix errors before merging."
          exit 1
        }
        
        if ($warnings) {
          Write-Host "âš ï¸ Build warnings found:"
          $warnings | ForEach-Object { Write-Host "  $_" }
          Write-Host "Please review and fix warnings if possible."
        } else {
          Write-Host "âœ… No build warnings found"
        }
      displayName: 'ðŸ” Check Build Warnings & Errors'

    # Code analysis - check for common issues
    - pwsh: |
        Write-Host "ðŸ“Š Running code analysis..."
        
        # Check for project structure
        $projects = Get-ChildItem -Path . -Filter "*.csproj" -Recurse | Where-Object { $_.FullName -notlike "*\bin\*" -and $_.FullName -notlike "*\obj\*" }
        Write-Host "Found $($projects.Count) project file(s)"
        
        # Check for solution file
        $solutions = Get-ChildItem -Path . -Filter "*.sln" -Recurse
        if ($solutions) {
          Write-Host "âœ… Solution file(s) found: $($solutions.Name -join ', ')"
        } else {
          Write-Host "âš ï¸ No solution file found"
        }
        
        # Check for test projects (informational only)
        $testProjects = $projects | Where-Object { $_.FullName -like "*Test*" -or $_.FullName -like "*test*" }
        if ($testProjects) {
          Write-Host "â„¹ï¸ Found $($testProjects.Count) test project(s) (not executing)"
        }
      displayName: 'ðŸ“Š Code Structure Analysis'

    # Validate code compiles
    - pwsh: |
        Write-Host "âœ… Code compilation verified (passed in Build stage)"
        Write-Host "âœ… All projects compile successfully"
      displayName: 'âœ… Compilation Validation'

    # Summary
    - pwsh: |
        Write-Host "=========================================="
        Write-Host "âœ… CODE QUALITY VALIDATION COMPLETE"
        Write-Host "=========================================="
        Write-Host "âœ“ Code compiles successfully"
        Write-Host "âœ“ Build warnings/errors checked"
        Write-Host "âœ“ Code structure validated"
        Write-Host "âœ“ Ready for Azure DevOps review"
        Write-Host "=========================================="
        
        $prNumber = "$(System.PullRequest.PullRequestNumber)"
        # Get target branch from environment variable (System.PullRequest.TargetBranch is not a valid predefined variable)
        $prTargetBranch = $env:SYSTEM_PULLREQUEST_TARGETBRANCH
        if (-not $prTargetBranch) {
          $prTargetBranch = ""
        }
        
        if ($prNumber -and $prNumber -ne "") {
          Write-Host "Azure DevOps PR: $prNumber"
          if ($prTargetBranch) {
            Write-Host "Branch: $(Build.SourceBranchName) -> $prTargetBranch"
          } else {
            Write-Host "Source Branch: $(Build.SourceBranchName)"
          }
        } else {
          Write-Host "Source Branch: $(Build.SourceBranchName)"
        }
        Write-Host "=========================================="
      displayName: 'ðŸ“‹ Quality Check Summary'

