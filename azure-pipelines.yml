trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore
      displayName: 'Restore Dependencies'

    - script: dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'Build Solution'

    - script: dotnet test --configuration $(buildConfiguration) --no-build
      displayName: 'Run Unit Tests'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true
      displayName: 'Publish Web Projects'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
      displayName: 'Publish Build Artifacts'

- stage: E2E_Testing
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: E2E_Test_Job
    displayName: 'Run Playwright E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet build tests/E2E.Tests/E2E.Tests.csproj --configuration $(buildConfiguration) --no-restore
      displayName: 'Build Playwright E2E Project'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: |
        $scriptPath = "$(Build.SourcesDirectory)/tests/E2E.Tests/bin/$(buildConfiguration)/net8.0/playwright.ps1"
        
        Write-Host "Looking for playwright.ps1 at: $scriptPath"
        if (-not (Test-Path $scriptPath)) {
          Write-Error "playwright.ps1 not found! Build failed or wrong path."
          exit 1
        }

        Write-Host "Installing Playwright browsers (project-local)..."
        pwsh -ExecutionPolicy Bypass -File $scriptPath install chromium

        Write-Host "Browser installation completed."
        if (Test-Path "$(Build.SourcesDirectory)\.playwright") {
          Write-Host "Success: Browsers installed in .playwright folder"
          dir "$(Build.SourcesDirectory)\.playwright" -Recurse | Select-Object -First 15
        } else {
          Write-Error "Failed: .playwright folder not created"
          exit 1
        }
      displayName: 'Install Playwright Browsers'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: |
        Write-Host "Starting Microservices..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        Set-Location "$(Build.SourcesDirectory)/src/InventoryService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5001" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5000" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderWeb.Mvc"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5002" -NoNewWindow

        Write-Host "Waiting 20 seconds for services to initialize..."
        Start-Sleep -Seconds 20
      displayName: 'Start Microservices'

    - pwsh: |
        Write-Host "Running Playwright E2E tests..."
        dotnet test tests/E2E.Tests/E2E.Tests.csproj `
          --configuration $(buildConfiguration) `
          --no-build `
          --settings tests/E2E.Tests/.runsettings `
          --logger "trx;LogFileName=playwright_results.trx"
      displayName: 'Run Playwright E2E Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      continueOnError: true
      env:
        DEBUG: 'pw:*'                   # Optional: verbose logs for debugging

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/playwright_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Playwright Test Results'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)/tests/E2E.Tests'
        ArtifactName: 'playwright-traces-screenshots-videos'
        publishLocation: 'Container'
      displayName: 'Publish Playwright Artifacts (Traces, Screenshots, Videos)'

  - job: Cypress_Test_Job
    displayName: 'Run Cypress E2E Tests'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - script: |
        cd tests/Cypress.Tests
        npm ci
      displayName: 'Install Cypress Dependencies'

    - script: |
        Write-Host "Starting Microservices..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        Set-Location "$(Build.SourcesDirectory)/src/InventoryService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5001" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5000" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderWeb.Mvc"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5002" -NoNewWindow

        Write-Host "Waiting 20 seconds for services to initialize..."
        Start-Sleep -Seconds 20
      displayName: 'Start Microservices'

    - script: |
        cd tests/Cypress.Tests
        npx cypress run --browser chrome
      displayName: 'Run Cypress Tests'
      env:
        CYPRESS_baseUrl: 'http://127.0.0.1:5002'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'tests/Cypress.Tests/cypress/results/*.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Cypress Test Results'

    - task: PublishBuildArtifacts@1
      condition: failed()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/screenshots'
        ArtifactName: 'cypress-screenshots'
      displayName: 'Publish Cypress Screenshots on Failure'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/videos'
        ArtifactName: 'cypress-videos'
      displayName: 'Publish Cypress Videos'

  - job: Selenium_Test_Job
    displayName: 'Run Selenium E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: |
        Write-Host "Starting Microservices with health checks..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        Set-Location "$(Build.SourcesDirectory)/src/InventoryService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5001" -NoNewWindow -PassThru

        Set-Location "$(Build.SourcesDirectory)/src/OrderService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5000" -NoNewWindow -PassThru

        Set-Location "$(Build.SourcesDirectory)/src/OrderWeb.Mvc"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5002" -NoNewWindow -PassThru

        $maxAttempts = 30
        $attempt = 0
        $allReady = $false

        while ($attempt -lt $maxAttempts -and -not $allReady) {
          Start-Sleep -Seconds 2
          $attempt++

          $inventoryReady = $false
          $orderReady = $false
          $webReady = $false

          try { if ((Invoke-WebRequest -Uri http://127.0.0.1:5001/api/inventory/health -UseBasicParsing -ErrorAction SilentlyContinue).StatusCode -eq 200) { $inventoryReady = $true } } catch {}
          try { if ((Invoke-WebRequest -Uri http://127.0.0.1:5000/swagger/index.html -UseBasicParsing -ErrorAction SilentlyContinue).StatusCode -eq 200) { $orderReady = $true } } catch {}
          try { if ((Invoke-WebRequest -Uri http://127.0.0.1:5002 -UseBasicParsing -ErrorAction SilentlyContinue).StatusCode -eq 200) { $webReady = $true } } catch {}

          $allReady = $inventoryReady -and $orderReady -and $webReady

          if (-not $allReady) {
            Write-Host "Attempt $attempt/$maxAttempts - Inventory: $inventoryReady, Order: $orderReady, Web: $webReady"
          }
        }

        if (-not $allReady) {
          Write-Error "Services did not start in time!"
          exit 1
        }
        Write-Host "All services are ready!"
      displayName: 'Start Microservices with Health Checks'

    - script: |
        dotnet test tests/Selenium.Tests/Selenium.Tests.csproj --configuration $(buildConfiguration) --no-build --logger "trx;LogFileName=selenium_results.trx"
      displayName: 'Run Selenium Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        HEADLESS_MODE: 'true'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/selenium_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Selenium Test Results'