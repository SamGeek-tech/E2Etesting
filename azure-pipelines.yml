trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore
      displayName: 'Restore Dependencies'

    - script: dotnet build --configuration $(buildConfiguration)
      displayName: 'Build Solution'

    - script: dotnet test --configuration $(buildConfiguration) --no-build
      displayName: 'Run Unit Tests'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

- stage: E2E_Testing
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: E2E_Test_Job
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet build tests/E2E.Tests/E2E.Tests.csproj --configuration $(buildConfiguration)
      displayName: 'Build E2E Project'

    - script: |
        $scriptPath = "tests/E2E.Tests/bin/$(buildConfiguration)/net8.0/playwright.ps1"
        if (Test-Path $scriptPath) {
          pwsh -ExecutionPolicy Bypass -File $scriptPath install --with-deps chromium
        } else {
          dotnet tool install --global Microsoft.Playwright.CLI
          playwright install --with-deps chromium
        }
      displayName: 'Install Playwright Browsers'

    - script: |
        Write-Host "Starting Services..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        
        Start-Process dotnet -ArgumentList "run --project src/InventoryService.Api/InventoryService.Api.csproj --urls=http://127.0.0.1:5001" -NoNewWindow
        Start-Process dotnet -ArgumentList "run --project src/OrderService.Api/OrderService.Api.csproj --urls=http://127.0.0.1:5000" -NoNewWindow
        Start-Process dotnet -ArgumentList "run --project src/OrderWeb.Mvc/OrderWeb.Mvc.csproj --urls=http://127.0.0.1:5002" -NoNewWindow
        
        Write-Host "Waiting for services to initialize..."
        Start-Sleep -Seconds 15
      displayName: 'Start Microservices'

    - pwsh: |
        dotnet test tests/E2E.Tests/E2E.Tests.csproj `
          --configuration $(buildConfiguration) `
          --no-build `
          --settings tests/E2E.Tests/.runsettings `
          --logger "trx;LogFileName=playwright_results.trx"
      displayName: 'Run Playwright E2E Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      continueOnError: true
      env:
        PLAYWRIGHT_BROWSERS_PATH: '0'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/playwright_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Playwright Test Results'

    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)/tests/E2E.Tests'
        ArtifactName: 'playwright-traces'
        publishLocation: 'Container'
      displayName: 'Publish Playwright Traces & Screenshots'

  - job: Cypress_Test_Job
    displayName: 'Run Cypress E2E Tests'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - script: |
        cd tests/Cypress.Tests
        npm install
      displayName: 'Install Cypress Dependencies'

    - script: |
        Write-Host "Starting Services..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        
        Start-Process dotnet -ArgumentList "run --project src/InventoryService.Api/InventoryService.Api.csproj --urls=http://127.0.0.1:5001" -NoNewWindow
        Start-Process dotnet -ArgumentList "run --project src/OrderService.Api/OrderService.Api.csproj --urls=http://127.0.0.1:5000" -NoNewWindow
        Start-Process dotnet -ArgumentList "run --project src/OrderWeb.Mvc/OrderWeb.Mvc.csproj --urls=http://127.0.0.1:5002" -NoNewWindow
        
        Write-Host "Waiting for services to initialize..."
        Start-Sleep -Seconds 15
      displayName: 'Start Microservices'

    - script: |
        cd tests/Cypress.Tests
        npx cypress run --browser chrome
      displayName: 'Run Cypress Tests'
      env:
        CYPRESS_baseUrl: 'http://127.0.0.1:5002'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'tests/Cypress.Tests/cypress/results/*.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Cypress Test Results'

    - task: PublishBuildArtifacts@1
      condition: failed()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/screenshots'
        ArtifactName: 'cypress-screenshots'
      displayName: 'Publish Cypress Screenshots'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/videos'
        ArtifactName: 'cypress-videos'
      displayName: 'Publish Cypress Videos'

  - job: Selenium_Test_Job
    displayName: 'Run Selenium E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: |
        Write-Host "Starting Services..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        
        Start-Process dotnet -ArgumentList "run --project src/InventoryService.Api/InventoryService.Api.csproj --urls=http://127.0.0.1:5001" -NoNewWindow -PassThru | Out-Null
        Start-Process dotnet -ArgumentList "run --project src/OrderService.Api/OrderService.Api.csproj --urls=http://127.0.0.1:5000" -NoNewWindow -PassThru | Out-Null
        Start-Process dotnet -ArgumentList "run --project src/OrderWeb.Mvc/OrderWeb.Mvc.csproj --urls=http://127.0.0.1:5002" -NoNewWindow -PassThru | Out-Null
        
        Write-Host "Waiting for services to initialize..."
        $maxAttempts = 30
        $attempt = 0
        $allReady = $false
        
        while ($attempt -lt $maxAttempts -and -not $allReady) {
          Start-Sleep -Seconds 2
          $attempt++
          
          $inventoryReady = $false
          $orderReady = $false
          $webReady = $false
          
          try {
            $response = Invoke-WebRequest -Uri "http://127.0.0.1:5001/api/inventory/health" -TimeoutSec 2 -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) { $inventoryReady = $true }
          } catch { }
          
          try {
            $response = Invoke-WebRequest -Uri "http://127.0.0.1:5000/swagger/index.html" -TimeoutSec 2 -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) { $orderReady = $true }
          } catch { }
          
          try {
            $response = Invoke-WebRequest -Uri "http://127.0.0.1:5002" -TimeoutSec 2 -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) { $webReady = $true }
          } catch { }
          
          $allReady = $inventoryReady -and $orderReady -and $webReady
          
          if (-not $allReady) {
            Write-Host "Attempt $attempt/$maxAttempts - Inventory: $inventoryReady, Order: $orderReady, Web: $webReady"
          }
        }
        
        if (-not $allReady) {
          Write-Host "Services did not become ready in time!"
          exit 1
        }
        
        Write-Host "All services are ready!"
      displayName: 'Start Microservices'

    - script: |
        $env:HEADLESS_MODE = "true"
        dotnet test tests/Selenium.Tests/Selenium.Tests.csproj --configuration $(buildConfiguration) --logger "trx;LogFileName=selenium_results.xml"
      displayName: 'Run Selenium Tests'
      env:
        HEADLESS_MODE: 'true'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/selenium_results.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Selenium Test Results'


