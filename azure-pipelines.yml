trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore
      displayName: 'Restore Dependencies'

    - script: dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'Build Solution'

    - script: dotnet test --configuration $(buildConfiguration) --no-build
      displayName: 'Run Unit Tests'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true
      displayName: 'Publish Web Projects'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
      displayName: 'Publish Build Artifacts'

- stage: E2E_Testing
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: E2E_Test_Job
    displayName: 'Run Playwright E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet build tests/E2E.Tests/E2E.Tests.csproj --configuration $(buildConfiguration) --no-restore
      displayName: 'Build Playwright E2E Project'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: |
        $scriptPath = "$(Build.SourcesDirectory)/tests/E2E.Tests/bin/$(buildConfiguration)/net8.0/playwright.ps1"
        
        Write-Host "Looking for playwright.ps1 at: $scriptPath"
        if (-not (Test-Path $scriptPath)) {
          Write-Error "playwright.ps1 not found! Build failed or wrong path."
          exit 1
        }

        Write-Host "Installing Playwright browsers (project-local)..."
        pwsh -ExecutionPolicy Bypass -File $scriptPath install chromium

        Write-Host "Browser installation completed."
        if (Test-Path "$(Build.SourcesDirectory)\.playwright") {
          Write-Host "Success: Browsers installed in .playwright folder"
          dir "$(Build.SourcesDirectory)\.playwright" -Recurse | Select-Object -First 15
        } else {
          Write-Error "Failed: .playwright folder not created"
          exit 1
        }
      displayName: 'Install Playwright Browsers'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: |
        Write-Host "Starting Microservices..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        Set-Location "$(Build.SourcesDirectory)/src/InventoryService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5001" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5000" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderWeb.Mvc"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5002" -NoNewWindow

        Write-Host "Waiting 20 seconds for services to initialize..."
        Start-Sleep -Seconds 20
      displayName: 'Start Microservices'

    - pwsh: |
        Write-Host "Running Playwright E2E tests..."
        dotnet test tests/E2E.Tests/E2E.Tests.csproj `
          --configuration $(buildConfiguration) `
          --no-build `
          --settings tests/E2E.Tests/.runsettings `
          --logger "trx;LogFileName=playwright_results.trx"
      displayName: 'Run Playwright E2E Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      continueOnError: true
      env:
        DEBUG: 'pw:*'                   # Optional: verbose logs for debugging

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/playwright_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Playwright Test Results'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)/tests/E2E.Tests'
        ArtifactName: 'playwright-traces-screenshots-videos'
        publishLocation: 'Container'
      displayName: 'Publish Playwright Artifacts (Traces, Screenshots, Videos)'

  - job: Cypress_Test_Job
    displayName: 'Run Cypress E2E Tests'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - script: |
        cd tests/Cypress.Tests
        npm ci
      displayName: 'Install Cypress Dependencies'

    - script: |
        Write-Host "Starting Microservices..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        Set-Location "$(Build.SourcesDirectory)/src/InventoryService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5001" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderService.Api"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5000" -NoNewWindow

        Set-Location "$(Build.SourcesDirectory)/src/OrderWeb.Mvc"
        Start-Process dotnet -ArgumentList "run --urls=http://127.0.0.1:5002" -NoNewWindow

        Write-Host "Waiting 20 seconds for services to initialize..."
        Start-Sleep -Seconds 20
      displayName: 'Start Microservices'

    - script: |
        cd tests/Cypress.Tests
        npx cypress run --browser chrome
      displayName: 'Run Cypress Tests'
      env:
        CYPRESS_baseUrl: 'http://127.0.0.1:5002'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'tests/Cypress.Tests/cypress/results/*.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Cypress Test Results'

    - task: PublishBuildArtifacts@1
      condition: failed()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/screenshots'
        ArtifactName: 'cypress-screenshots'
      displayName: 'Publish Cypress Screenshots on Failure'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/videos'
        ArtifactName: 'cypress-videos'
      displayName: 'Publish Cypress Videos'

    - job: Selenium_Test_Job
    displayName: 'Run Selenium E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: |
        Write-Host "Starting Microservices (detached) for Selenium tests..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        # InventoryService.Api → port 5001
        Set-Location "$(Build.SourcesDirectory)/src/InventoryService.Api"
        Start-Process powershell -ArgumentList "-NoLogo -NoProfile -Command `"dotnet run --urls=http://127.0.0.1:5001`"" -RedirectStandardOutput "inventory.log" -RedirectStandardError "inventory_err.log"

        # OrderService.Api → port 5000
        Set-Location "$(Build.SourcesDirectory)/src/OrderService.Api"
        Start-Process powershell -ArgumentList "-NoLogo -NoProfile -Command `"dotnet run --urls=http://127.0.0.1:5000`"" -RedirectStandardOutput "order.log" -RedirectStandardError "order_err.log"

        # OrderWeb.Mvc (frontend) → port 5002
        Set-Location "$(Build.SourcesDirectory)/src/OrderWeb.Mvc"
        Start-Process powershell -ArgumentList "-NoLogo -NoProfile -Command `"dotnet run --urls=http://127.0.0.1:5002`"" -RedirectStandardOutput "web.log" -RedirectStandardError "web_err.log"

        Write-Host "Processes launched in background. Waiting 40 seconds for startup..."
        Start-Sleep -Seconds 40

        # Health checks with detailed output
        Write-Host "Performing health checks..."

        $inventoryReady = $false
        try {
          $resp = Invoke-WebRequest -Uri http://127.0.0.1:5001/api/inventory/health -UseBasicParsing -TimeoutSec 10
          if ($resp.StatusCode -eq 200) { $inventoryReady = $true; Write-Host "Inventory API ready (5001)" }
        } catch { Write-Warning "Inventory API not ready: $_" }

        $orderReady = $false
        try {
          $resp = Invoke-WebRequest -Uri http://127.0.0.1:5000/swagger/index.html -UseBasicParsing -TimeoutSec 10
          if ($resp.StatusCode -eq 200) { $orderReady = $true; Write-Host "Order API ready (5000)" }
        } catch { Write-Warning "Order API not ready: $_" }

        $webReady = $false
        try {
          $resp = Invoke-WebRequest -Uri http://127.0.0.1:5002 -UseBasicParsing -TimeoutSec 10
          if ($resp.StatusCode -eq 200) { $webReady = $true; Write-Host "Web app ready (5002)" }
        } catch { Write-Warning "Web app not ready: $_" }

        if (-not ($inventoryReady -and $orderReady -and $webReady)) {
          Write-Error "One or more services failed to start properly!"
          exit 1
        }

        Write-Host "All services are up and running!"
      displayName: 'Start Microservices (Detached)'

    - script: |
        dotnet test tests/Selenium.Tests/Selenium.Tests.csproj `
          --configuration $(buildConfiguration) `
          --no-build `
          --logger "trx;LogFileName=selenium_results.trx"
      displayName: 'Run Selenium Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        HEADLESS_MODE: 'true'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/selenium_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Selenium Test Results'

    # Optional: dump logs if something goes wrong (very useful for debugging)
    - script: |
        Write-Host "=== Web App Log (last 50 lines) ==="
        Get-Content "$(Build.SourcesDirectory)/src/OrderWeb.Mvc/web.log" -Tail 50 -ErrorAction SilentlyContinue || echo "No log file"
        Write-Host "=== Web App Error Log ==="
        Get-Content "$(Build.SourcesDirectory)/src/OrderWeb.Mvc/web_err.log" -Tail 50 -ErrorAction SilentlyContinue || echo "No error log"

        Write-Host "=== Order API Log (last 50 lines) ==="
        Get-Content "$(Build.SourcesDirectory)/src/OrderService.Api/order.log" -Tail 50 -ErrorAction SilentlyContinue || echo "No log"
      displayName: 'Dump Service Logs on Failure'
      condition: failed()