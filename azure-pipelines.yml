trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore
      displayName: 'Restore Dependencies'

    - script: dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'Build Solution'

    - script: dotnet test --configuration $(buildConfiguration) --no-build
      displayName: 'Run Unit Tests'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true
      displayName: 'Publish Web Projects'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
      displayName: 'Publish Build Artifacts'

- stage: E2E_Testing
  dependsOn: Build
  condition: succeeded()
  jobs:

  # ==================== PLAYWRIGHT E2E ====================
  - job: E2E_Test_Job
    displayName: 'Run Playwright E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - pwsh: |
        $scriptPath = "tests/E2E.Tests/bin/$(buildConfiguration)/net8.0/playwright.ps1"
        if (Test-Path $scriptPath) {
          pwsh -ExecutionPolicy Bypass -File $scriptPath install --with-deps chromium
        } else {
          dotnet tool install --global Microsoft.Playwright.CLI
          playwright install --with-deps chromium
        }
      displayName: 'Install Playwright Browsers'

    - script: dotnet build tests/E2E.Tests/E2E.Tests.csproj --configuration $(buildConfiguration) --no-restore
      displayName: 'Build Playwright E2E Project'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: dotnet build E2Etesting.sln --configuration $(buildConfiguration)
      displayName: 'Build Solution (Prevent Parallel Race Conditions)'

    - pwsh: |
        Write-Host "Starting Microservices (detached)..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        # Clean ports first
        netstat -ano | findstr :5000 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null
        netstat -ano | findstr :5001 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null
        netstat -ano | findstr :5002 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null

        # Run with --no-build since we just built it. This prevents race conditions.
        $invArgs = "run --project src/InventoryService.Api/InventoryService.Api.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5001"
        Start-Process dotnet -ArgumentList $invArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"

        $ordArgs = "run --project src/OrderService.Api/OrderService.Api.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5000"
        Start-Process dotnet -ArgumentList $ordArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"

        $webArgs = "run --project src/OrderWeb.Mvc/OrderWeb.Mvc.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5002"
        Start-Process dotnet -ArgumentList $webArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"

        Write-Host "Waiting 60 seconds for services to start..."
        Start-Sleep -Seconds 60
      displayName: 'Start Microservices (Playwright)'

    - pwsh: |
        dotnet test tests/E2E.Tests/E2E.Tests.csproj `
          --configuration $(buildConfiguration) `
          --no-build `
          --settings tests/E2E.Tests/.runsettings `
          --logger "trx;LogFileName=playwright_results.trx"
      displayName: 'Run Playwright E2E Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      continueOnError: true
      env:
        PLAYWRIGHT_BROWSERS_PATH: '0'
        DEBUG: 'pw:*'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/playwright_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Playwright Test Results'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)/tests/E2E.Tests'
        ArtifactName: 'playwright-traces-screenshots-videos'

  # ==================== CYPRESS E2E ====================
  - job: Cypress_Test_Job
    displayName: 'Run Cypress E2E Tests'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - script: |
        cd tests/Cypress.Tests
        npm ci
      displayName: 'Install Cypress Dependencies'

    - script: dotnet build E2Etesting.sln --configuration $(buildConfiguration)
      displayName: 'Build Solution (Prepare for Cypress)'

    - pwsh: |
        Write-Host "Starting Microservices for Cypress..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        netstat -ano | findstr :5000 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null
        netstat -ano | findstr :5001 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null
        netstat -ano | findstr :5002 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null

        $invArgs = "run --project src/InventoryService.Api/InventoryService.Api.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5001"
        Start-Process dotnet -ArgumentList $invArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"

        $ordArgs = "run --project src/OrderService.Api/OrderService.Api.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5000"
        Start-Process dotnet -ArgumentList $ordArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"

        $webArgs = "run --project src/OrderWeb.Mvc/OrderWeb.Mvc.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5002"
        Start-Process dotnet -ArgumentList $webArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"

        Start-Sleep -Seconds 60
      displayName: 'Start Microservices (Cypress)'

    - script: |
        cd tests/Cypress.Tests
        npx cypress run --browser chrome
      displayName: 'Run Cypress Tests'
      env:
        CYPRESS_baseUrl: 'http://127.0.0.1:5002'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'tests/Cypress.Tests/cypress/results/*.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Cypress Test Results'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/videos'
        ArtifactName: 'cypress-videos'
      displayName: 'Publish Cypress Videos'

  # ==================== SELENIUM E2E ====================
  - job: Selenium_Test_Job
    displayName: 'Run Selenium E2E Tests'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet build E2Etesting.sln --configuration $(buildConfiguration)
      displayName: 'Build Solution (Prepare for Selenium)'

    - pwsh: |
        Write-Host "Starting Microservices for Selenium (robust startup)..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"

        # Force kill any lingering processes on our ports
        netstat -ano | findstr :5000 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null
        netstat -ano | findstr :5001 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null
        netstat -ano | findstr :5002 | for /f "tokens=5" %a in ('more') do taskkill /PID %a /F 2>$null

        # Start services detached with full logging
        $invArgs = "run --project src/InventoryService.Api/InventoryService.Api.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5001"
        Start-Process dotnet -ArgumentList $invArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"

        $ordArgs = "run --project src/OrderService.Api/OrderService.Api.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5000"
        Start-Process dotnet -ArgumentList $ordArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"

        $webArgs = "run --project src/OrderWeb.Mvc/OrderWeb.Mvc.csproj --configuration $(buildConfiguration) --no-build --urls=http://127.0.0.1:5002"
        Start-Process dotnet -ArgumentList $webArgs -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"

        Write-Host "Waiting 60 seconds for services to fully start..."
        Start-Sleep -Seconds 60
      displayName: 'Start Microservices (Selenium)'
    - pwsh: |
        $allGood = $true
        try { Invoke-WebRequest http://127.0.0.1:5002 -TimeoutSec 10 | Out-Null; Write-Host "Web app (5002) OK" } catch { Write-Warning "Web app FAILED: $_"; $allGood = $false }
        try { Invoke-WebRequest http://127.0.0.1:5000/swagger/index.html -TimeoutSec 10 | Out-Null; Write-Host "Order API (5000) OK" } catch { Write-Warning "Order API FAILED: $_"; $allGood = $false }
        try { Invoke-WebRequest http://127.0.0.1:5001/api/inventory/health -TimeoutSec 10 | Out-Null; Write-Host "Inventory API (5001) OK" } catch { Write-Warning "Inventory API FAILED: $_"; $allGood = $false }

        if (-not $allGood) {
          Write-Error "Services failed to start properly!"
          exit 1
        }
      displayName: 'Start Microservices (Selenium)'

    - pwsh: |
        dotnet test tests/Selenium.Tests/Selenium.Tests.csproj `
          --configuration $(buildConfiguration) `
          --no-build `
          --logger "trx;LogFileName=selenium_results.trx"
      displayName: 'Run Selenium Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        HEADLESS_MODE: 'true'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/selenium_results.trx'
        failTaskOnFailedTests: true
      displayName: 'Publish Selenium Test Results'

    # Critical: This will show you the real reason if the app crashes
    - pwsh: |
        Write-Host "=== DUMPING SERVICE LOGS (Selenium Job) ==="
        Write-Host "`n--- Web App (5002) STDOUT ---"
        Get-Content "$(Build.SourcesDirectory)/web.log" -Tail 100 -ErrorAction SilentlyContinue || Write-Host "No log"
        Write-Host "`n--- Web App ERROR LOG ---"
        Get-Content "$(Build.SourcesDirectory)/web_err.log" -Tail 100 -ErrorAction SilentlyContinue || Write-Host "No error log"
        Write-Host "`n--- Order API STDOUT ---"
        Get-Content "$(Build.SourcesDirectory)/order.log" -Tail 100 -ErrorAction SilentlyContinue
        Write-Host "`n--- Inventory API STDOUT ---"
        Get-Content "$(Build.SourcesDirectory)/inventory.log" -Tail 100 -ErrorAction SilentlyContinue
      displayName: 'Dump Service Logs (Debug Connection Issues)'
      condition: always()