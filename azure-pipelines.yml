trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  displayName: 'ğŸ”¨ Build & Unit Tests'
  jobs:
  - job: BuildJob
    displayName: 'Build Solution'
    steps:
    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘              ğŸš€ PIPELINE STARTED - BUILD STAGE                 â•‘" -ForegroundColor Cyan
        Write-Host "â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘" -ForegroundColor Cyan
        Write-Host "â•‘  Build ID:      $(Build.BuildId)"
        Write-Host "â•‘  Build Number:  $(Build.BuildNumber)"
        Write-Host "â•‘  Branch:        $(Build.SourceBranchName)"
        Write-Host "â•‘  Commit:        $(Build.SourceVersion)"
        Write-Host "â•‘  Agent:         $(Agent.MachineName)"
        Write-Host "â•‘  Config:        $(buildConfiguration)"
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host ""
      displayName: 'ğŸ“‹ Pipeline Info'

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET 8 SDK'

    - pwsh: |
        Write-Host "â–¶ï¸ [STEP 1/5] Restoring NuGet packages..." -ForegroundColor Yellow
        dotnet restore
        Write-Host "âœ… [STEP 1/5] Restore complete" -ForegroundColor Green
      displayName: 'ğŸ“¦ [1/5] Restore Dependencies'

    - pwsh: |
        Write-Host "â–¶ï¸ [STEP 2/5] Building solution..." -ForegroundColor Yellow
        dotnet build --configuration $(buildConfiguration) --no-restore
        Write-Host "âœ… [STEP 2/5] Build complete" -ForegroundColor Green
      displayName: 'ğŸ”¨ [2/5] Build Solution'

    - pwsh: |
        Write-Host "â–¶ï¸ [STEP 3/5] Running unit tests..." -ForegroundColor Yellow
        dotnet test tests/Unit.Tests/Unit.Tests.csproj --configuration $(buildConfiguration) --no-build --logger "trx;LogFileName=unit_test_results.trx"
        Write-Host "âœ… [STEP 3/5] Unit tests complete" -ForegroundColor Green
      displayName: 'ğŸ§ª [3/5] Run Unit Tests'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/unit_test_results.trx'
        failTaskOnFailedTests: true
      displayName: 'ğŸ“Š Publish Unit Test Results'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true
      displayName: 'ğŸ“¤ [4/5] Publish Web Projects'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
      displayName: 'ğŸ’¾ [5/5] Publish Build Artifacts'

    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
        Write-Host "â•‘           âœ… BUILD STAGE COMPLETED SUCCESSFULLY                â•‘" -ForegroundColor Green
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
      displayName: 'âœ… Build Stage Complete'
      condition: succeeded()

- stage: E2E_Testing
  displayName: 'ğŸ§ª E2E Integration Tests'
  dependsOn: Build
  condition: succeeded()
  jobs:

  # ==================== PLAYWRIGHT E2E ====================
  - job: E2E_Test_Job
    displayName: 'ğŸ­ Playwright Tests .NET'
    steps:
    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
        Write-Host "â•‘           ğŸ­ PLAYWRIGHT E2E TEST JOB STARTED                   â•‘" -ForegroundColor Magenta
        Write-Host "â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘" -ForegroundColor Magenta
        Write-Host "â•‘  Job:    E2E_Test_Job (Playwright)"
        Write-Host "â•‘  Agent:  $(Agent.MachineName)"
        Write-Host "â•‘  Status: INITIALIZING"
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
      displayName: 'ğŸ“‹ Playwright Job Info'

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET 8 SDK'

    - pwsh: |
        Write-Host "â–¶ï¸ [PLAYWRIGHT 1/4] Building test project..." -ForegroundColor Yellow
        dotnet build tests/E2E.Tests/E2E.Tests.csproj --configuration $(buildConfiguration)
        Write-Host "âœ… [PLAYWRIGHT 1/4] Test project built" -ForegroundColor Green
      displayName: 'ğŸ”¨ [1/4] Build Playwright E2E Project'
      workingDirectory: '$(Build.SourcesDirectory)'

    - pwsh: |
        Write-Host "â–¶ï¸ [PLAYWRIGHT 2/4] Installing Playwright browsers..." -ForegroundColor Yellow
        $scriptPath = "tests/E2E.Tests/bin/$(buildConfiguration)/net8.0/playwright.ps1"
        if (Test-Path $scriptPath) {
          Write-Host "   Found playwright.ps1 at: $scriptPath"
          pwsh -ExecutionPolicy Bypass -File $scriptPath install --with-deps chromium
        } else {
          Write-Host "   playwright.ps1 not found, using dotnet tool..." -ForegroundColor Yellow
          dotnet tool update --global Microsoft.Playwright.CLI 2>$null
          playwright install --with-deps chromium
        }
        Write-Host "âœ… [PLAYWRIGHT 2/4] Browsers installed" -ForegroundColor Green
      displayName: 'ğŸŒ [2/4] Install Playwright Browsers'

    - pwsh: |
        Write-Host "â–¶ï¸ [PLAYWRIGHT 3/4] Building solution for services..." -ForegroundColor Yellow
        dotnet build E2Etesting.sln --configuration $(buildConfiguration)
        Write-Host "âœ… [PLAYWRIGHT 3/4] Solution built" -ForegroundColor Green
      displayName: 'ğŸ”¨ [3/4] Build Solution'

    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘     â–¶ï¸ [PLAYWRIGHT 4/4] STARTING SERVICES & RUNNING TESTS      â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸš€ Starting Microservices for Playwright..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        $env:PLAYWRIGHT_BROWSERS_PATH = "0"

        # Start Inventory Service
        $invProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/InventoryService.Api/InventoryService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5001"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"
        Write-Host "Started Inventory Service (PID: $($invProc.Id))"

        # Start Order Service
        $ordProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderService.Api/OrderService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5000"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"
        Write-Host "Started Order Service (PID: $($ordProc.Id))"

        # Start Web MVC
        $webProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderWeb.Mvc/OrderWeb.Mvc.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5002"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"
        Write-Host "Started Web MVC (PID: $($webProc.Id))"

        Write-Host ""
        Write-Host "â³ STATE: WAITING FOR SERVICES..." -ForegroundColor Yellow
        Write-Host "   Polling services (timeout: 120s)..."
        $maxWait = 120
        $elapsed = 0
        $allReady = $false

        while ($elapsed -lt $maxWait -and -not $allReady) {
          Start-Sleep -Seconds 5
          $elapsed += 5
          
          $webOk = $false
          $invOk = $false
          $ordOk = $false
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5002" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $webOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5001/api/inventory" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $invOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5000/swagger/index.html" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $ordOk = $true 
          } catch { }
          
          $allReady = $webOk -and $invOk -and $ordOk
          $webStatus = if ($webOk) { "âœ…" } else { "â³" }
          $invStatus = if ($invOk) { "âœ…" } else { "â³" }
          $ordStatus = if ($ordOk) { "âœ…" } else { "â³" }
          Write-Host "   [$elapsed`s] Web:$webStatus Inventory:$invStatus Order:$ordStatus"
        }

        if (-not $allReady) {
          Write-Host ""
          Write-Host "âŒ STATE: SERVICES FAILED TO START" -ForegroundColor Red
          Write-Host "=== DUMPING ERROR LOGS ===" -ForegroundColor Red
          Write-Host "--- inventory_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/inventory_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- order_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/order_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- web_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/web_err.log" -ErrorAction SilentlyContinue
          exit 1
        }

        Write-Host ""
        Write-Host "âœ… STATE: ALL SERVICES READY" -ForegroundColor Green
        Write-Host ""
        Write-Host "ğŸ§ª STATE: RUNNING PLAYWRIGHT TESTS..." -ForegroundColor Cyan
        
        # Run tests IN THE SAME SCRIPT to keep services alive
        $testResult = 0
        try {
          dotnet test tests/E2E.Tests/E2E.Tests.csproj `
            --configuration $(buildConfiguration) `
            --no-build `
            --settings tests/E2E.Tests/.runsettings `
            --logger "trx;LogFileName=playwright_results.trx"
          $testResult = $LASTEXITCODE
        } finally {
          Write-Host ""
          Write-Host "ğŸ›‘ STATE: STOPPING SERVICES..." -ForegroundColor Yellow
          if ($invProc -and !$invProc.HasExited) { Stop-Process -Id $invProc.Id -Force -ErrorAction SilentlyContinue }
          if ($ordProc -and !$ordProc.HasExited) { Stop-Process -Id $ordProc.Id -Force -ErrorAction SilentlyContinue }
          if ($webProc -and !$webProc.HasExited) { Stop-Process -Id $webProc.Id -Force -ErrorAction SilentlyContinue }
          Write-Host "âœ… Services stopped" -ForegroundColor Green
        }
        
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
        Write-Host "â•‘           ğŸ­ PLAYWRIGHT TESTS COMPLETED                        â•‘" -ForegroundColor Magenta
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
        
        # Don't fail the step so we can publish results - the PublishTestResults task will fail if needed
        exit 0
      displayName: 'ğŸ§ª [4/4] Start Services & Run Playwright Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        PLAYWRIGHT_BROWSERS_PATH: '0'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/playwright_results.trx'
        failTaskOnFailedTests: true
      displayName: 'ğŸ“Š Publish Playwright Test Results'

    - pwsh: |
        $outputDir = "$(Build.SourcesDirectory)/tests/E2E.Tests/bin/$(buildConfiguration)/net8.0"
        $artifactDir = "$(Build.SourcesDirectory)/playwright-dotnet-artifacts"
        
        Write-Host "Collecting Playwright .NET artifacts from: $outputDir"
        New-Item -ItemType Directory -Path $artifactDir -Force | Out-Null
        
        # Copy trace files
        $traces = Get-ChildItem -Path $outputDir -Filter "*.zip" -Recurse -ErrorAction SilentlyContinue
        if ($traces) {
          $tracesDir = "$artifactDir/traces"
          New-Item -ItemType Directory -Path $tracesDir -Force | Out-Null
          $traces | Copy-Item -Destination $tracesDir
          Write-Host "âœ… Copied $($traces.Count) trace file(s)"
        } else {
          Write-Host "âš ï¸ No trace files found"
        }
        
        # Copy screenshots
        $screenshots = Get-ChildItem -Path $outputDir -Filter "*.png" -Recurse -ErrorAction SilentlyContinue
        if ($screenshots) {
          $screenshotsDir = "$artifactDir/screenshots"
          New-Item -ItemType Directory -Path $screenshotsDir -Force | Out-Null
          $screenshots | Copy-Item -Destination $screenshotsDir
          Write-Host "âœ… Copied $($screenshots.Count) screenshot(s)"
        } else {
          Write-Host "âš ï¸ No screenshots found"
        }
        
        # Copy videos folder if exists
        $videosDir = "$outputDir/videos"
        if (Test-Path $videosDir) {
          Copy-Item -Path $videosDir -Destination "$artifactDir/videos" -Recurse
          Write-Host "âœ… Copied videos folder"
        } else {
          Write-Host "âš ï¸ No videos folder found"
        }
        
        # Create README if no artifacts found
        $hasArtifacts = (Get-ChildItem -Path $artifactDir -Recurse -File).Count -gt 0
        if (-not $hasArtifacts) {
          "No traces, screenshots, or videos were recorded during this test run." | Out-File "$artifactDir/README.txt"
          Write-Host "âš ï¸ No artifacts found, created placeholder"
        }
        
        Write-Host "Artifact directory contents:"
        Get-ChildItem -Path $artifactDir -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
      displayName: 'ğŸ“ Collect Playwright .NET Artifacts'
      condition: always()

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)/playwright-dotnet-artifacts'
        ArtifactName: 'playwright-dotnet-traces-screenshots-videos'
      displayName: 'ğŸ“ Publish Playwright .NET Artifacts'

  # ==================== PLAYWRIGHT NODE.JS E2E ====================
  - job: PlaywrightNode_Test_Job
    displayName: 'ğŸ­ Playwright Tests Node.js'
    steps:
    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
        Write-Host "â•‘        ğŸ­ PLAYWRIGHT NODE.JS E2E TEST JOB STARTED              â•‘" -ForegroundColor Magenta
        Write-Host "â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘" -ForegroundColor Magenta
        Write-Host "â•‘  Job:    PlaywrightNode_Test_Job"
        Write-Host "â•‘  Agent:  $(Agent.MachineName)"
        Write-Host "â•‘  Status: INITIALIZING"
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
      displayName: 'ğŸ“‹ Playwright Node.js Job Info'

    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'âš™ï¸ Setup Node.js 20'

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET 8 SDK'

    - pwsh: |
        Write-Host "â–¶ï¸ [PW-NODE 1/4] Installing dependencies..." -ForegroundColor Yellow
        Push-Location tests/PlaywrightNode.Tests
        npm ci
        Pop-Location
        Write-Host "âœ… [PW-NODE 1/4] Dependencies installed" -ForegroundColor Green
      displayName: 'ğŸ“¦ [1/4] Install Node Dependencies'

    - pwsh: |
        Write-Host "â–¶ï¸ [PW-NODE 2/4] Installing Playwright browsers..." -ForegroundColor Yellow
        Push-Location tests/PlaywrightNode.Tests
        npx playwright install --with-deps chromium
        Pop-Location
        Write-Host "âœ… [PW-NODE 2/4] Browsers installed" -ForegroundColor Green
      displayName: 'ğŸŒ [2/4] Install Playwright Browsers'

    - pwsh: |
        Write-Host "â–¶ï¸ [PW-NODE 3/4] Building solution for services..." -ForegroundColor Yellow
        dotnet build E2Etesting.sln --configuration $(buildConfiguration)
        Write-Host "âœ… [PW-NODE 3/4] Solution built" -ForegroundColor Green
      displayName: 'ğŸ”¨ [3/4] Build Solution'

    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘   â–¶ï¸ [PW-NODE 4/4] STARTING SERVICES & RUNNING TESTS           â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸš€ Starting Microservices for Playwright Node.js..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        $env:CI = "true"

        # Start Inventory Service
        Write-Host "   Starting Inventory Service..."
        $invProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/InventoryService.Api/InventoryService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5001"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"
        Write-Host "   âœ“ Inventory Service started (PID: $($invProc.Id))"

        # Start Order Service
        Write-Host "   Starting Order Service..."
        $ordProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderService.Api/OrderService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5000"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"
        Write-Host "   âœ“ Order Service started (PID: $($ordProc.Id))"

        # Start Web MVC
        Write-Host "   Starting Web MVC..."
        $webProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderWeb.Mvc/OrderWeb.Mvc.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5002"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"
        Write-Host "   âœ“ Web MVC started (PID: $($webProc.Id))"

        Write-Host ""
        Write-Host "â³ STATE: WAITING FOR SERVICES..." -ForegroundColor Yellow
        $maxWait = 120
        $elapsed = 0
        $allReady = $false

        while ($elapsed -lt $maxWait -and -not $allReady) {
          Start-Sleep -Seconds 5
          $elapsed += 5
          
          $webOk = $false
          $invOk = $false
          $ordOk = $false
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5002" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $webOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5001/api/inventory" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $invOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5000/swagger/index.html" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $ordOk = $true 
          } catch { }
          
          $allReady = $webOk -and $invOk -and $ordOk
          $webStatus = if ($webOk) { "âœ…" } else { "â³" }
          $invStatus = if ($invOk) { "âœ…" } else { "â³" }
          $ordStatus = if ($ordOk) { "âœ…" } else { "â³" }
          Write-Host "   [$elapsed`s] Web:$webStatus Inventory:$invStatus Order:$ordStatus"
        }

        if (-not $allReady) {
          Write-Host ""
          Write-Host "âŒ STATE: SERVICES FAILED TO START" -ForegroundColor Red
          Write-Host "=== DUMPING ERROR LOGS ===" -ForegroundColor Red
          Write-Host "--- inventory_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/inventory_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- order_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/order_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- web_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/web_err.log" -ErrorAction SilentlyContinue
          exit 1
        }

        Write-Host ""
        Write-Host "âœ… STATE: ALL SERVICES READY" -ForegroundColor Green
        Write-Host ""
        Write-Host "ğŸ§ª STATE: RUNNING PLAYWRIGHT NODE.JS TESTS..." -ForegroundColor Cyan
        
        # Run tests IN THE SAME SCRIPT to keep services alive
        Push-Location "tests/PlaywrightNode.Tests"
        try {
          npx playwright test --reporter=junit,html
        } finally {
          Pop-Location
          Write-Host ""
          Write-Host "ğŸ›‘ STATE: STOPPING SERVICES..." -ForegroundColor Yellow
          if ($invProc -and !$invProc.HasExited) { Stop-Process -Id $invProc.Id -Force -ErrorAction SilentlyContinue }
          if ($ordProc -and !$ordProc.HasExited) { Stop-Process -Id $ordProc.Id -Force -ErrorAction SilentlyContinue }
          if ($webProc -and !$webProc.HasExited) { Stop-Process -Id $webProc.Id -Force -ErrorAction SilentlyContinue }
          Write-Host "âœ… Services stopped" -ForegroundColor Green
        }
        
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
        Write-Host "â•‘         ğŸ­ PLAYWRIGHT NODE.JS TESTS COMPLETED                  â•‘" -ForegroundColor Magenta
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
      displayName: 'ğŸ§ª [4/4] Start Services & Run Playwright Node.js Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        CI: 'true'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'tests/PlaywrightNode.Tests/test-results/results.xml'
        failTaskOnFailedTests: true
      displayName: 'ğŸ“Š Publish Playwright Node.js Test Results'

    - pwsh: |
        $reportPath = "tests/PlaywrightNode.Tests/playwright-report"
        $resultsPath = "tests/PlaywrightNode.Tests/test-results"
        
        if (-not (Test-Path $reportPath)) {
          Write-Host "âš ï¸ Report directory not found, creating placeholder"
          New-Item -ItemType Directory -Path $reportPath -Force | Out-Null
          "No report generated" | Out-File "$reportPath/README.txt"
        }
        
        if (-not (Test-Path $resultsPath)) {
          Write-Host "âš ï¸ Results directory not found, creating placeholder"
          New-Item -ItemType Directory -Path $resultsPath -Force | Out-Null
          "No results generated" | Out-File "$resultsPath/README.txt"
        }
      displayName: 'ğŸ“ Prepare Playwright Node.js Artifacts'
      condition: always()

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/PlaywrightNode.Tests/playwright-report'
        ArtifactName: 'playwright-node-report'
      displayName: 'ğŸ“ Publish Playwright Node.js Report'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/PlaywrightNode.Tests/test-results'
        ArtifactName: 'playwright-node-traces'
      displayName: 'ğŸ“ Publish Playwright Node.js Traces'

  # ==================== CYPRESS E2E ====================
  - job: Cypress_Test_Job
    displayName: 'ğŸŒ² Cypress Tests'
    steps:
    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
        Write-Host "â•‘            ğŸŒ² CYPRESS E2E TEST JOB STARTED                     â•‘" -ForegroundColor Green
        Write-Host "â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘" -ForegroundColor Green
        Write-Host "â•‘  Job:    Cypress_Test_Job"
        Write-Host "â•‘  Agent:  $(Agent.MachineName)"
        Write-Host "â•‘  Status: INITIALIZING"
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
      displayName: 'ğŸ“‹ Cypress Job Info'

    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'âš™ï¸ Setup Node.js 20'

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET 8 SDK'

    - pwsh: |
        Write-Host "â–¶ï¸ [CYPRESS 1/4] Installing Cypress dependencies..." -ForegroundColor Yellow
        Push-Location tests/Cypress.Tests
        npm ci
        Pop-Location
        Write-Host "âœ… [CYPRESS 1/4] Dependencies installed" -ForegroundColor Green
      displayName: 'ğŸ“¦ [1/4] Install Cypress Dependencies'

    - pwsh: |
        Write-Host "â–¶ï¸ [CYPRESS 2/4] Building solution..." -ForegroundColor Yellow
        dotnet build E2Etesting.sln --configuration $(buildConfiguration)
        Write-Host "âœ… [CYPRESS 2/4] Solution built" -ForegroundColor Green
      displayName: 'ğŸ”¨ [2/4] Build Solution'

    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘      â–¶ï¸ [CYPRESS 3/4] STARTING SERVICES & RUNNING TESTS        â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸš€ Starting Microservices for Cypress..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        $env:CYPRESS_baseUrl = "http://127.0.0.1:5002"

        # Start Inventory Service
        Write-Host "   Starting Inventory Service..."
        $invProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/InventoryService.Api/InventoryService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5001"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"
        Write-Host "   âœ“ Inventory Service started (PID: $($invProc.Id))"

        # Start Order Service
        Write-Host "   Starting Order Service..."
        $ordProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderService.Api/OrderService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5000"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"
        Write-Host "   âœ“ Order Service started (PID: $($ordProc.Id))"

        # Start Web MVC
        Write-Host "   Starting Web MVC..."
        $webProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderWeb.Mvc/OrderWeb.Mvc.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5002"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"
        Write-Host "   âœ“ Web MVC started (PID: $($webProc.Id))"

        Write-Host ""
        Write-Host "â³ STATE: WAITING FOR SERVICES..." -ForegroundColor Yellow
        $maxWait = 120
        $elapsed = 0
        $allReady = $false

        while ($elapsed -lt $maxWait -and -not $allReady) {
          Start-Sleep -Seconds 5
          $elapsed += 5
          
          $webOk = $false
          $invOk = $false
          $ordOk = $false
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5002" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $webOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5001/api/inventory" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $invOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5000/swagger/index.html" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $ordOk = $true 
          } catch { }
          
          $allReady = $webOk -and $invOk -and $ordOk
          $webStatus = if ($webOk) { "âœ…" } else { "â³" }
          $invStatus = if ($invOk) { "âœ…" } else { "â³" }
          $ordStatus = if ($ordOk) { "âœ…" } else { "â³" }
          Write-Host "   [$elapsed`s] Web:$webStatus Inventory:$invStatus Order:$ordStatus"
        }

        if (-not $allReady) {
          Write-Host ""
          Write-Host "âŒ STATE: SERVICES FAILED TO START" -ForegroundColor Red
          Write-Host "=== DUMPING ERROR LOGS ===" -ForegroundColor Red
          Write-Host "--- inventory_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/inventory_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- order_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/order_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- web_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/web_err.log" -ErrorAction SilentlyContinue
          exit 1
        }

        Write-Host ""
        Write-Host "âœ… STATE: ALL SERVICES READY" -ForegroundColor Green
        Write-Host ""
        Write-Host "ğŸ§ª STATE: RUNNING CYPRESS TESTS..." -ForegroundColor Cyan
        
        # Run tests IN THE SAME SCRIPT to keep services alive
        Push-Location "tests/Cypress.Tests"
        try {
          npx cypress run --browser chrome
        } finally {
          Pop-Location
          Write-Host ""
          Write-Host "ğŸ›‘ STATE: STOPPING SERVICES..." -ForegroundColor Yellow
          if ($invProc -and !$invProc.HasExited) { Stop-Process -Id $invProc.Id -Force -ErrorAction SilentlyContinue }
          if ($ordProc -and !$ordProc.HasExited) { Stop-Process -Id $ordProc.Id -Force -ErrorAction SilentlyContinue }
          if ($webProc -and !$webProc.HasExited) { Stop-Process -Id $webProc.Id -Force -ErrorAction SilentlyContinue }
          Write-Host "âœ… Services stopped" -ForegroundColor Green
        }
        
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
        Write-Host "â•‘            ğŸŒ² CYPRESS TESTS COMPLETED                          â•‘" -ForegroundColor Green
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
      displayName: 'ğŸ§ª [3/3] Start Services & Run Cypress Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        CYPRESS_baseUrl: 'http://127.0.0.1:5002'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'tests/Cypress.Tests/cypress/results/*.xml'
        failTaskOnFailedTests: true
      displayName: 'ğŸ“Š Publish Cypress Test Results'

    - pwsh: |
        $videosPath = "tests/Cypress.Tests/cypress/videos"
        $screenshotsPath = "tests/Cypress.Tests/cypress/screenshots"
        
        if (Test-Path $videosPath) {
          Write-Host "âœ… Videos directory exists, will be published"
        } else {
          Write-Host "âš ï¸ Videos directory not found, creating empty placeholder"
          New-Item -ItemType Directory -Path $videosPath -Force | Out-Null
          "No videos recorded" | Out-File "$videosPath/README.txt"
        }
        
        if (Test-Path $screenshotsPath) {
          Write-Host "âœ… Screenshots directory exists"
        } else {
          Write-Host "âš ï¸ Screenshots directory not found, creating empty placeholder"
          New-Item -ItemType Directory -Path $screenshotsPath -Force | Out-Null
          "No screenshots recorded" | Out-File "$screenshotsPath/README.txt"
        }
      displayName: 'ğŸ“ Prepare Cypress Artifacts'
      condition: always()

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/videos'
        ArtifactName: 'cypress-videos'
      displayName: 'ğŸ“ Publish Cypress Videos'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        PathtoPublish: 'tests/Cypress.Tests/cypress/screenshots'
        ArtifactName: 'cypress-screenshots'
      displayName: 'ğŸ“ Publish Cypress Screenshots'

  # ==================== SELENIUM E2E ====================
  - job: Selenium_Test_Job
    displayName: 'ğŸ”¬ Selenium Tests'
    steps:
    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Blue
        Write-Host "â•‘           ğŸ”¬ SELENIUM E2E TEST JOB STARTED                     â•‘" -ForegroundColor Blue
        Write-Host "â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘" -ForegroundColor Blue
        Write-Host "â•‘  Job:    Selenium_Test_Job"
        Write-Host "â•‘  Agent:  $(Agent.MachineName)"
        Write-Host "â•‘  Status: INITIALIZING"
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Blue
      displayName: 'ğŸ“‹ Selenium Job Info'

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
      displayName: 'âš™ï¸ Setup .NET 8 SDK'

    - pwsh: |
        Write-Host "â–¶ï¸ [SELENIUM 1/2] Building solution..." -ForegroundColor Yellow
        dotnet build E2Etesting.sln --configuration $(buildConfiguration)
        Write-Host "âœ… [SELENIUM 1/2] Solution built" -ForegroundColor Green
      displayName: 'ğŸ”¨ [1/2] Build Solution'

    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘     â–¶ï¸ [SELENIUM 2/2] STARTING SERVICES & RUNNING TESTS        â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸš€ Starting Microservices for Selenium..."
        $env:ASPNETCORE_ENVIRONMENT = "Development"
        $env:HEADLESS_MODE = "true"

        # Start Inventory Service
        Write-Host "   Starting Inventory Service..."
        $invProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/InventoryService.Api/InventoryService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5001"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/inventory.log" -RedirectStandardError "$(Build.SourcesDirectory)/inventory_err.log"
        Write-Host "   âœ“ Inventory Service started (PID: $($invProc.Id))"

        # Start Order Service
        Write-Host "   Starting Order Service..."
        $ordProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderService.Api/OrderService.Api.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5000"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/order.log" -RedirectStandardError "$(Build.SourcesDirectory)/order_err.log"
        Write-Host "   âœ“ Order Service started (PID: $($ordProc.Id))"

        # Start Web MVC
        Write-Host "   Starting Web MVC..."
        $webProc = Start-Process -FilePath "dotnet" -ArgumentList @(
          "run",
          "--project", "src/OrderWeb.Mvc/OrderWeb.Mvc.csproj",
          "--configuration", "$(buildConfiguration)",
          "--no-build",
          "--urls=http://127.0.0.1:5002"
        ) -PassThru -RedirectStandardOutput "$(Build.SourcesDirectory)/web.log" -RedirectStandardError "$(Build.SourcesDirectory)/web_err.log"
        Write-Host "   âœ“ Web MVC started (PID: $($webProc.Id))"

        Write-Host ""
        Write-Host "â³ STATE: WAITING FOR SERVICES..." -ForegroundColor Yellow
        $maxWait = 120
        $elapsed = 0
        $allReady = $false

        while ($elapsed -lt $maxWait -and -not $allReady) {
          Start-Sleep -Seconds 5
          $elapsed += 5
          
          $webOk = $false
          $invOk = $false
          $ordOk = $false
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5002" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $webOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5001/api/inventory" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $invOk = $true 
          } catch { }
          
          try { 
            Invoke-WebRequest -Uri "http://127.0.0.1:5000/swagger/index.html" -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop | Out-Null
            $ordOk = $true 
          } catch { }
          
          $allReady = $webOk -and $invOk -and $ordOk
          $webStatus = if ($webOk) { "âœ…" } else { "â³" }
          $invStatus = if ($invOk) { "âœ…" } else { "â³" }
          $ordStatus = if ($ordOk) { "âœ…" } else { "â³" }
          Write-Host "   [$elapsed`s] Web:$webStatus Inventory:$invStatus Order:$ordStatus"
        }

        if (-not $allReady) {
          Write-Host ""
          Write-Host "âŒ STATE: SERVICES FAILED TO START" -ForegroundColor Red
          Write-Host "=== DUMPING ERROR LOGS ===" -ForegroundColor Red
          Write-Host "--- inventory_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/inventory_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- order_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/order_err.log" -ErrorAction SilentlyContinue
          Write-Host "--- web_err.log ---"
          Get-Content "$(Build.SourcesDirectory)/web_err.log" -ErrorAction SilentlyContinue
          exit 1
        }

        Write-Host ""
        Write-Host "âœ… STATE: ALL SERVICES READY" -ForegroundColor Green
        Write-Host ""
        Write-Host "ğŸ§ª STATE: RUNNING SELENIUM TESTS..." -ForegroundColor Cyan
        
        # Run tests IN THE SAME SCRIPT to keep services alive
        $testResult = 0
        try {
          dotnet test tests/Selenium.Tests/Selenium.Tests.csproj `
            --configuration $(buildConfiguration) `
            --no-build `
            --logger "trx;LogFileName=selenium_results.trx"
          $testResult = $LASTEXITCODE
        } finally {
          Write-Host ""
          Write-Host "ğŸ›‘ STATE: STOPPING SERVICES..." -ForegroundColor Yellow
          if ($invProc -and !$invProc.HasExited) { Stop-Process -Id $invProc.Id -Force -ErrorAction SilentlyContinue }
          if ($ordProc -and !$ordProc.HasExited) { Stop-Process -Id $ordProc.Id -Force -ErrorAction SilentlyContinue }
          if ($webProc -and !$webProc.HasExited) { Stop-Process -Id $webProc.Id -Force -ErrorAction SilentlyContinue }
          Write-Host "âœ… Services stopped" -ForegroundColor Green
        }
        
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Blue
        Write-Host "â•‘            ğŸ”¬ SELENIUM TESTS COMPLETED                         â•‘" -ForegroundColor Blue
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Blue
        
        exit $testResult
      displayName: 'ğŸ§ª [2/2] Start Services & Run Selenium Tests'
      workingDirectory: '$(Build.SourcesDirectory)'
      env:
        HEADLESS_MODE: 'true'

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/selenium_results.trx'
        failTaskOnFailedTests: true
      displayName: 'ğŸ“Š Publish Selenium Test Results'

    - pwsh: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Gray
        Write-Host "â•‘               ğŸ“œ SERVICE LOGS (Debug Info)                     â•‘" -ForegroundColor Gray
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Gray
        Write-Host "`n--- Web App (5002) STDOUT (last 50 lines) ---"
        Get-Content "$(Build.SourcesDirectory)/web.log" -Tail 50 -ErrorAction SilentlyContinue || Write-Host "No log"
        Write-Host "`n--- Web App ERROR LOG ---"
        Get-Content "$(Build.SourcesDirectory)/web_err.log" -Tail 50 -ErrorAction SilentlyContinue || Write-Host "No error log"
        Write-Host "`n--- Order API STDOUT (last 50 lines) ---"
        Get-Content "$(Build.SourcesDirectory)/order.log" -Tail 50 -ErrorAction SilentlyContinue
        Write-Host "`n--- Inventory API STDOUT (last 50 lines) ---"
        Get-Content "$(Build.SourcesDirectory)/inventory.log" -Tail 50 -ErrorAction SilentlyContinue
      displayName: 'ğŸ“œ Dump Service Logs (Debug)'
      condition: always()